{% extends 'modelo.html' %}
{% load static %}
{% block titulo %}<title>{{ title }}</title>{% endblock %}

{% block conteudo %}
<main class="main-content">
  <header class="content-header">
    <h1>{{ titulo }}</h1>
    <div class="header-actions">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Pesquisar parcelas a pagar..." />
        <i class="fas fa-search"></i>
      </div>
      {% block admin %}{% endblock %}
      <button class="btn btn-notification" id="notificationBtn">
        <i class="fas fa-bell"></i>
        {% if notificacoes_count > 0 %}
        <span class="badge">{{ notificacoes_count }}</span>
        {% endif %}
      </button>
    </div>
  </header>
  {% block conteudo_admin %}{% endblock %}
{% endblock %}

{% block cards %}{% endblock %}

{% block graficos %}
  <style>
    /* Card de Lista */
    .lista-card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.08);
      padding: 0;
      margin: 1.5rem auto;
      max-width: 1400px;
      overflow: hidden;
      animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .lista-header {
      background: linear-gradient(135deg, #ef5350 0%, #c62828 100%);
      color: white;
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .lista-title-section {
      flex: 1;
    }

    .lista-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .lista-subtitle {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .lista-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .btn-add {
      background-color: white;
      color: #c62828;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-add:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      background-color: #f5f5f5;
    }

    /* Tema Vermelho para Parcelas de Despesas (A Pagar) */
    .parcelas-filters {
      background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(198, 40, 40, 0.15);
      margin: 20px auto;
      max-width: 1200px;
      border: 2px solid #ef5350;
    }

    .filter-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .filter-btn {
      padding: 10px 20px;
      border: 2px solid #ef5350;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #c62828;
    }

    .filter-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(239, 83, 80, 0.3);
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #ef5350 0%, #c62828 100%);
      color: white;
      border-color: #c62828;
    }

    .filter-btn.status-pago {
      border-color: #10b981;
    }

    .filter-btn.status-pago.active {
      background: #10b981;
      border-color: #10b981;
    }

    .filter-btn.status-pendente {
      border-color: #f59e0b;
    }

    .filter-btn.status-pendente.active {
      background: #f59e0b;
      border-color: #f59e0b;
    }

    .filter-btn.status-vencido {
      border-color: #b91c1c;
    }

    .filter-btn.status-vencido.active {
      background: #b91c1c;
      border-color: #b91c1c;
    }

    .filter-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      padding-top: 15px;
      border-top: 2px solid #ef5350;
    }

    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-left: 4px solid #ef5350;
    }

    .stat-label {
      color: #666;
      font-size: 13px;
      margin-bottom: 5px;
    }

    .stat-value {
      font-weight: bold;
      font-size: 20px;
      color: #c62828;
    }

    /* Badges de status */
    .status-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-block;
      letter-spacing: 0.5px;
    }

    .status-pago {
      background: #d1fae5;
      color: #065f46;
    }

    .status-pendente {
      background: #fef3c7;
      color: #92400e;
    }

    .status-vencido {
      background: #fee2e2;
      color: #991b1b;
    }

    /* Destaque visual nas linhas */
    .modelo-table tbody tr.parcela-vencida {
      background: #fef2f2 !important;
      border-left: 4px solid #dc2626;
    }

    .modelo-table tbody tr.parcela-paga {
      background: #f0fdf4 !important;
      opacity: 0.85;
    }

    .modelo-table tbody tr.parcela-paga:hover {
      opacity: 1 !important;
      transform: scale(1.01);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }

    .modelo-table tbody tr.parcela-pendente {
      background: white !important;
    }

    .modelo-table tbody tr:hover {
      background: #ffebee !important;
      transform: scale(1.01);
      box-shadow: 0 4px 12px rgba(198, 40, 40, 0.15);
      transition: all 0.3s;
    }

    /* Valor destacado */
    .valor-destaque {
      font-weight: bold;
      font-size: 15px;
    }

    .valor-pago {
      color: #10b981;
    }

    .valor-pendente {
      color: #c62828;
    }

    /* Informa√ß√£o da movimenta√ß√£o */
    .info-movimentacao {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    /* Contador de filtros */
    .filter-count {
      background: white;
      color: #c62828;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 12px;
      margin-left: 5px;
      font-weight: bold;
    }

    /* Bot√µes de A√ß√£o */
    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .btn-edit {
      color: #1976d2;
      background-color: #e3f2fd;
    }

    .btn-edit:hover {
      background-color: #bbdefb;
      transform: scale(1.1);
    }

    .btn-delete {
      color: #d32f2f;
      background-color: #ffebee;
    }

    .btn-delete:hover {
      background-color: #ffcdd2;
      transform: scale(1.1);
    }
  </style>

  <div class="lista-card">
    <!-- Header da Lista -->
    <div class="lista-header">
      <div class="lista-title-section">
        <h2 class="lista-title">
          <i class="fas fa-money-check-alt"></i> Parcelas a Pagar
        </h2>
        <p class="lista-subtitle">Gerenciamento de parcelas pendentes e pagas</p>
      </div>
      <div class="lista-actions">
        <a href="{% url 'cadastrar_despesa' %}" class="btn-add">
          <i class="fas fa-plus"></i>
          Nova Despesa
        </a>
      </div>
    </div>

  <!-- Filtros e Estat√≠sticas -->
  <div class="parcelas-filters">
    <div class="filter-buttons">
      <button class="filter-btn active" data-filter="todos">
        <i class="fas fa-list"></i>
        Todas <span class="filter-count" id="count-todos">0</span>
      </button>
      <button class="filter-btn status-pago" data-filter="pago">
        <i class="fas fa-check-circle"></i>
        Pagas <span class="filter-count" id="count-pago">0</span>
      </button>
      <button class="filter-btn status-pendente" data-filter="pendente">
        <i class="fas fa-clock"></i>
        Pendentes <span class="filter-count" id="count-pendente">0</span>
      </button>
      <button class="filter-btn status-vencido" data-filter="vencido">
        <i class="fas fa-exclamation-triangle"></i>
        Vencidas <span class="filter-count" id="count-vencido">0</span>
      </button>
    </div>

    <div class="filter-stats">
      <div class="stat-card">
        <div class="stat-label">üí∏ Total de Parcelas</div>
        <div class="stat-value" id="total-parcelas">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">üìä Valor Total</div>
        <div class="stat-value" id="valor-total">R$ 0,00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">‚è≥ Valor a Pagar</div>
        <div class="stat-value" style="color: #c62828;" id="valor-pendente">R$ 0,00</div>
      </div>
    </div>
  </div>

  <!-- Tabela de Parcelas a Pagar -->
  <div class="modelo-lista-container">
    <div class="table-container">
      <table class="modelo-table">
        <thead>
          <tr>
            <th>Fornecedor/Parceiro</th>
            <th>Parcela</th>
            <th>Valor</th>
            <th>Vencimento</th>
            <th>Valor Pago</th>
            <th>Status</th>
            <th>Pagamento</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="parcelas-tbody">
          {% for parcela in object_list %}
            {% now "Y-m-d" as today %}
            <tr class="parcela-row {% if parcela.status_pagamento == 'Pago' %}parcela-paga{% elif parcela.data_vencimento|date:'Y-m-d' < today and parcela.status_pagamento != 'Pago' %}parcela-vencida{% else %}parcela-pendente{% endif %}" 
                data-status="{% if parcela.status_pagamento == 'Pago' %}pago{% elif parcela.data_vencimento|date:'Y-m-d' < today and parcela.status_pagamento != 'Pago' %}vencido{% else %}pendente{% endif %}"
                data-valor="{{ parcela.valor_parcela }}"
                data-valor-pago="{{ parcela.valor_pago }}"
                data-search="{{ parcela.movimentacao.tipo }} {{ parcela.movimentacao.parceiros.nome }} {{ parcela.ordem_parcela }}">
              
              <td>
                <strong style="color: #c62828;">{{ parcela.movimentacao.parceiros.nome }}</strong>
                <div class="info-movimentacao">
                  <i class="fas fa-tag" style="color: #ef5350;"></i> {{ parcela.movimentacao.categoria.nome }}
                  | <i class="fas fa-home" style="color: #ef5350;"></i> {{ parcela.movimentacao.fazenda.nome }}
                </div>
              </td>
              
              <td style="text-align: center;">
                <strong style="font-size: 16px; color: #c62828;">{{ parcela.ordem_parcela }}/{{ parcela.movimentacao.parcelas }}</strong>
              </td>
              
              <td class="valor-destaque valor-pendente">
                R$ {{ parcela.valor_parcela|floatformat:2 }}
              </td>
              
              <td>
                <strong>{{ parcela.data_vencimento|date:"d/m/Y" }}</strong>
                <div style="font-size: 12px; color: #666; margin-top: 4px;">
                  {{ parcela.data_vencimento|date:"D" }}
                </div>
                {% if parcela.status_pagamento != 'Pago' and parcela.data_vencimento|date:'Y-m-d' < today %}
                  <div style="font-size: 11px; color: #dc2626; margin-top: 3px; font-weight: 600;">
                    <i class="fas fa-exclamation-circle"></i> Atrasada
                  </div>
                {% endif %}
              </td>
              
              <td class="valor-destaque {% if parcela.valor_pago >= parcela.valor_parcela %}valor-pago{% else %}valor-pendente{% endif %}">
                R$ {{ parcela.valor_pago|floatformat:2 }}
              </td>
              
              <td>
                {% if parcela.status_pagamento == 'Pago' %}
                  <span class="status-badge status-pago">
                    <i class="fas fa-check-circle"></i> Pago
                  </span>
                {% elif parcela.data_vencimento|date:'Y-m-d' < today %}
                  <span class="status-badge status-vencido">
                    <i class="fas fa-exclamation-triangle"></i> Vencida
                  </span>
                {% else %}
                  <span class="status-badge status-pendente">
                    <i class="fas fa-clock"></i> Pendente
                  </span>
                {% endif %}
              </td>
              
              <td>
                {% if parcela.data_quitacao %}
                  <strong style="color: #10b981;">{{ parcela.data_quitacao|date:"d/m/Y" }}</strong>
                {% else %}
                  <span style="color: #999;">-</span>
                {% endif %}
              </td>
              
              <td style="text-align: center;">
                <div class="action-buttons">
                  <a href="{% url 'editar_parcela' parcela.id %}" 
                     class="btn-icon btn-edit"
                     title="Editar parcela">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a href="{% url 'excluir_parcela' parcela.id %}" 
                     class="btn-icon btn-delete"
                     title="Excluir parcela">
                    <i class="fas fa-trash-alt"></i>
                  </a>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                <div>{{ registros }}</div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const filterButtons = document.querySelectorAll('.filter-btn');
      const parcelaRows = document.querySelectorAll('.parcela-row');
      const searchInput = document.getElementById('searchInput');
      let currentFilter = 'todos';

      calcularEstatisticas();

      filterButtons.forEach(button => {
        button.addEventListener('click', function() {
          filterButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          currentFilter = this.dataset.filter;
          aplicarFiltros();
        });
      });

      searchInput.addEventListener('input', aplicarFiltros);

      function aplicarFiltros() {
        const searchTerm = searchInput.value.toLowerCase();
        
        parcelaRows.forEach(row => {
          const status = row.dataset.status;
          const searchData = row.dataset.search.toLowerCase();
          
          const statusMatch = currentFilter === 'todos' || status === currentFilter;
          const searchMatch = searchTerm === '' || searchData.includes(searchTerm);
          
          row.style.display = (statusMatch && searchMatch) ? '' : 'none';
        });
        
        calcularEstatisticas();
      }

      function calcularEstatisticas() {
        let totalParcelas = 0;
        let totalPagas = 0;
        let totalPendentes = 0;
        let totalVencidas = 0;
        let valorTotal = 0;
        let valorPendente = 0;  // Valor a pagar (pendentes + vencidas)
        
        // Contadores gerais para os badges (TODOS os registros)
        let countTodosGeral = 0;
        let countPagoGeral = 0;
        let countPendenteGeral = 0;
        let countVencidoGeral = 0;

        // Primeiro loop: conta TODOS os registros para os badges dos filtros
        parcelaRows.forEach(row => {
          const status = row.dataset.status;
          
          countTodosGeral++;
          if (status === 'pago') countPagoGeral++;
          else if (status === 'vencido') countVencidoGeral++;
          else if (status === 'pendente') countPendenteGeral++;
        });

        // Segundo loop: calcula estat√≠sticas apenas das linhas VIS√çVEIS
        parcelaRows.forEach(row => {
          if (row.style.display !== 'none') {
            const status = row.dataset.status;
            const valor = parseFloat(row.dataset.valor);
            const valorPg = parseFloat(row.dataset.valorPago);

            totalParcelas++;
            valorTotal += valor;

            if (status === 'pago') {
              totalPagas++;
            } else if (status === 'vencido') {
              totalVencidas++;
              valorPendente += (valor - valorPg);  // Soma pendentes e vencidas
            } else if (status === 'pendente') {
              totalPendentes++;
              valorPendente += (valor - valorPg);  // Soma pendentes e vencidas
            }
          }
        });

        // Atualiza contadores dos filtros (sempre mostram o total geral)
        document.getElementById('count-todos').textContent = countTodosGeral;
        document.getElementById('count-pago').textContent = countPagoGeral;
        document.getElementById('count-pendente').textContent = countPendenteGeral;
        document.getElementById('count-vencido').textContent = countVencidoGeral;

        // Atualiza estat√≠sticas (mostram apenas o que est√° vis√≠vel)
        document.getElementById('total-parcelas').textContent = totalParcelas;
        document.getElementById('valor-total').textContent = formatarMoeda(valorTotal);
        document.getElementById('valor-pendente').textContent = formatarMoeda(valorPendente);
      }

      function formatarMoeda(valor) {
        return 'R$ ' + valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      }
    });
  </script>
  </div>
{% endblock %}

{% block ultimos_registros %}{% endblock %}
</main>
