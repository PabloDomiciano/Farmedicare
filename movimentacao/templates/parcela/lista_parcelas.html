{% extends 'modelo.html' %}{% extends 'modelo.html' %}

{% load static %}

{% block conteudo %}{% block titulo %}<title>{{ title }}</title>{% endblock %}

<div class="container">

    <h1>{{ titulo }}</h1>{% block conteudo %}

    <p>{{ subtitulo }}</p>  <main class="main-content">

        <header class="content-header">

    {% if parcelas %}      <h1>{{ titulo }}</h1>

        <table class="table">      <div class="header-actions">

            <thead>        <div class="search-box">

                <tr>          <input type="text" id="searchInput" placeholder="Pesquisar parcelas..." />

                    <th>Parcela</th>          <i class="fas fa-search"></i>

                    <th>Movimentação</th>        </div>

                    <th>Valor</th>        {% block admin %}{% endblock %}

                    <th>Vencimento</th>        <button class="btn btn-notification">

                    <th>Status</th>          <i class="fas fa-bell"></i>

                </tr>          <span class="badge">3</span>

            </thead>        </button>

            <tbody>      </div>

                {% for parcela in parcelas %}      <button class="mobile-menu-btn">

                <tr>        <i class="fas fa-bars"></i>

                    <td>{{ parcela.numero_parcela }}</td>      </button>

                    <td>{{ parcela.movimentacao }}</td>    </header>

                    <td>R$ {{ parcela.valor }}</td>    {% block conteudo_admin %}

                    <td>{{ parcela.data_vencimento }}</td>    {% endblock %}

                    <td>{{ parcela.status }}</td>  {% endblock %}

                </tr>  

                {% endfor %}  {% block cards %}{% endblock %}

            </tbody>  

        </table>  {% block graficos %}

    {% else %}    <style>

        <p>{{ registros }}</p>      /* Estilos para filtros e badges */

    {% endif %}      .parcelas-filters {

</div>        background: white;

{% endblock %}        padding: 20px;

        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin: 20px auto;
        max-width: 1200px;
      }

      .filter-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 15px;
      }

      .filter-btn {
        padding: 10px 20px;
        border: 2px solid #e0e0e0;
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .filter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }

      .filter-btn.active {
        border-color: #4a8f29;
        background: #4a8f29;
        color: white;
      }

      .filter-btn.status-pago {
        border-color: #10b981;
      }

      .filter-btn.status-pago.active {
        background: #10b981;
        border-color: #10b981;
      }

      .filter-btn.status-pendente {
        border-color: #f59e0b;
      }

      .filter-btn.status-pendente.active {
        background: #f59e0b;
        border-color: #f59e0b;
      }

      .filter-btn.status-vencido {
        border-color: #ef4444;
      }

      .filter-btn.status-vencido.active {
        background: #ef4444;
        border-color: #ef4444;
      }

      .filter-stats {
        display: flex;
        gap: 20px;
        padding-top: 15px;
        border-top: 1px solid #e0e0e0;
        flex-wrap: wrap;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }

      .stat-label {
        color: #666;
      }

      .stat-value {
        font-weight: bold;
        font-size: 16px;
      }

      /* Badges de status */
      .status-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        display: inline-block;
        letter-spacing: 0.5px;
      }

      .status-pago {
        background: #d1fae5;
        color: #065f46;
      }

      .status-pendente {
        background: #fef3c7;
        color: #92400e;
      }

      .status-vencido {
        background: #fee2e2;
        color: #991b1b;
      }

      /* Destaque visual nas linhas */
      .modelo-table tbody tr.parcela-vencida {
        background: #fef2f2 !important;
        border-left: 4px solid #ef4444;
      }

      .modelo-table tbody tr.parcela-paga {
        background: #f0fdf4 !important;
        opacity: 0.8;
      }

      .modelo-table tbody tr.parcela-paga:hover {
        opacity: 1 !important;
      }

      .modelo-table tbody tr.parcela-pendente {
        background: #fffbeb !important;
      }

      /* Valor destacado */
      .valor-destaque {
        font-weight: bold;
        font-size: 15px;
      }

      .valor-pago {
        color: #10b981;
      }

      .valor-pendente {
        color: #f59e0b;
      }

      /* Ícones de status */
      .status-icon {
        margin-right: 6px;
      }

      /* Informação da movimentação */
      .info-movimentacao {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
      }

      /* Contador de filtros */
      .filter-count {
        background: #4a8f29;
        color: white;
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 12px;
        margin-left: 5px;
      }

      /* Responsivo */
      @media (max-width: 768px) {
        .filter-buttons {
          gap: 8px;
        }

        .filter-btn {
          padding: 8px 14px;
          font-size: 13px;
        }

        .filter-stats {
          gap: 12px;
        }

        .stat-item {
          font-size: 12px;
        }

        .stat-value {
          font-size: 14px;
        }
      }
    </style>

    <!-- Filtros e Estatísticas -->
    <div class="parcelas-filters">
      <div class="filter-buttons">
        <button class="filter-btn active" data-filter="todos">
          <i class="fas fa-list"></i>
          Todas <span class="filter-count" id="count-todos">0</span>
        </button>
        <button class="filter-btn status-pago" data-filter="pago">
          <i class="fas fa-check-circle"></i>
          Pagas <span class="filter-count" id="count-pago">0</span>
        </button>
        <button class="filter-btn status-pendente" data-filter="pendente">
          <i class="fas fa-clock"></i>
          Pendentes <span class="filter-count" id="count-pendente">0</span>
        </button>
        <button class="filter-btn status-vencido" data-filter="vencido">
          <i class="fas fa-exclamation-triangle"></i>
          Vencidas <span class="filter-count" id="count-vencido">0</span>
        </button>
      </div>

      <div class="filter-stats">
        <div class="stat-item">
          <span class="stat-label">Total de Parcelas:</span>
          <span class="stat-value" id="total-parcelas">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Valor Total:</span>
          <span class="stat-value" id="valor-total">R$ 0,00</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Valor Pago:</span>
          <span class="stat-value" style="color: #10b981;" id="valor-pago">R$ 0,00</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Valor Pendente:</span>
          <span class="stat-value" style="color: #f59e0b;" id="valor-pendente">R$ 0,00</span>
        </div>
      </div>
    </div>

    <!-- Tabela de Parcelas -->
    <div class="modelo-lista-container">
      <div class="table-container">
        <table class="modelo-table">
          <thead>
            <tr>
              <th>Movimentação</th>
              <th>Parcela</th>
              <th>Valor</th>
              <th>Vencimento</th>
              <th>Valor Pago</th>
              <th>Status</th>
              <th>Quitação</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="parcelas-tbody">
            {% for parcela in object_list %}
              {% now "Y-m-d" as today %}
              <tr class="parcela-row {% if parcela.status_pagamento == 'Pago' %}parcela-paga{% elif parcela.data_vencimento|date:'Y-m-d' < today and parcela.status_pagamento != 'Pago' %}parcela-vencida{% else %}parcela-pendente{% endif %}" 
                  data-status="{% if parcela.status_pagamento == 'Pago' %}pago{% elif parcela.data_vencimento|date:'Y-m-d' < today and parcela.status_pagamento != 'Pago' %}vencido{% else %}pendente{% endif %}"
                  data-valor="{{ parcela.valor_parcela }}"
                  data-valor-pago="{{ parcela.valor_pago }}"
                  data-search="{{ parcela.movimentacao.tipo }} {{ parcela.movimentacao.parceiros.nome }} {{ parcela.ordem_parcela }}">
                
                <td>
                  <strong>{{ parcela.movimentacao.parceiros.nome }}</strong>
                  <div class="info-movimentacao">
                    <i class="fas fa-{% if parcela.movimentacao.tipo == 'receita' %}arrow-up{% else %}arrow-down{% endif %}"></i>
                    {{ parcela.movimentacao.tipo|title }} - {{ parcela.movimentacao.categoria.nome }}
                  </div>
                </td>
                
                <td style="text-align: center;">
                  <strong>{{ parcela.ordem_parcela }}/{{ parcela.movimentacao.parcelas }}</strong>
                </td>
                
                <td class="valor-destaque">R$ {{ parcela.valor_parcela|floatformat:2 }}</td>
                
                <td>
                  {{ parcela.data_vencimento|date:"d/m/Y" }}
                  {% if parcela.status_pagamento != 'Pago' and parcela.data_vencimento|date:'Y-m-d' < today %}
                    <div style="color: #ef4444; font-size: 11px; margin-top: 3px;">
                      <i class="fas fa-exclamation-circle"></i> Vencida
                    </div>
                  {% endif %}
                </td>
                
                <td class="valor-destaque {% if parcela.valor_pago >= parcela.valor_parcela %}valor-pago{% else %}valor-pendente{% endif %}">
                  R$ {{ parcela.valor_pago|floatformat:2 }}
                </td>
                
                <td>
                  {% if parcela.status_pagamento == 'Pago' %}
                    <span class="status-badge status-pago">
                      <i class="fas fa-check-circle status-icon"></i>
                      Pago
                    </span>
                  {% elif parcela.data_vencimento|date:'Y-m-d' < today %}
                    <span class="status-badge status-vencido">
                      <i class="fas fa-times-circle status-icon"></i>
                      Vencido
                    </span>
                  {% else %}
                    <span class="status-badge status-pendente">
                      <i class="fas fa-clock status-icon"></i>
                      Pendente
                    </span>
                  {% endif %}
                </td>
                
                <td>
                  {% if parcela.data_quitacao %}
                    {{ parcela.data_quitacao|date:"d/m/Y" }}
                  {% else %}
                    <span style="color: #999;">-</span>
                  {% endif %}
                </td>
                
                <td class="actions">
                  <a href="{% url 'editar_parcela' parcela.id %}" class="btn-edit">
                    <i class="fas fa-edit"></i> Editar
                  </a>
                  <a href="{% url 'excluir_parcela' parcela.id %}" class="btn-delete">
                    <i class="fas fa-trash"></i> Excluir
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                  <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                  <div>{{ registros }}</div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const filterButtons = document.querySelectorAll('.filter-btn');
        const parcelaRows = document.querySelectorAll('.parcela-row');
        const searchInput = document.getElementById('searchInput');
        let currentFilter = 'todos';

        // Calcular estatísticas iniciais
        calcularEstatisticas();

        // Filtros de status
        filterButtons.forEach(button => {
          button.addEventListener('click', function() {
            // Remover active de todos
            filterButtons.forEach(btn => btn.classList.remove('active'));
            // Adicionar active ao clicado
            this.classList.add('active');
            
            currentFilter = this.dataset.filter;
            aplicarFiltros();
          });
        });

        // Busca
        searchInput.addEventListener('input', function() {
          aplicarFiltros();
        });

        function aplicarFiltros() {
          const searchTerm = searchInput.value.toLowerCase();
          let visibleCount = 0;

          parcelaRows.forEach(row => {
            const status = row.dataset.status;
            const searchData = row.dataset.search.toLowerCase();
            
            // Verificar filtro de status
            const statusMatch = currentFilter === 'todos' || status === currentFilter;
            
            // Verificar busca
            const searchMatch = searchTerm === '' || searchData.includes(searchTerm);
            
            if (statusMatch && searchMatch) {
              row.style.display = '';
              visibleCount++;
            } else {
              row.style.display = 'none';
            }
          });

          // Atualizar contadores
          calcularEstatisticas();
        }

        function calcularEstatisticas() {
          let totalParcelas = 0;
          let totalPagas = 0;
          let totalPendentes = 0;
          let totalVencidas = 0;
          let valorTotal = 0;
          let valorPago = 0;
          let valorPendente = 0;

          parcelaRows.forEach(row => {
            const status = row.dataset.status;
            const valor = parseFloat(row.dataset.valor);
            const valorPg = parseFloat(row.dataset.valorPago);

            totalParcelas++;
            valorTotal += valor;
            valorPago += valorPg;

            if (status === 'pago') {
              totalPagas++;
            } else if (status === 'vencido') {
              totalVencidas++;
              valorPendente += (valor - valorPg);
            } else if (status === 'pendente') {
              totalPendentes++;
              valorPendente += (valor - valorPg);
            }
          });

          // Atualizar contadores nos botões
          document.getElementById('count-todos').textContent = totalParcelas;
          document.getElementById('count-pago').textContent = totalPagas;
          document.getElementById('count-pendente').textContent = totalPendentes;
          document.getElementById('count-vencido').textContent = totalVencidas;

          // Atualizar estatísticas
          document.getElementById('total-parcelas').textContent = totalParcelas;
          document.getElementById('valor-total').textContent = formatarMoeda(valorTotal);
          document.getElementById('valor-pago').textContent = formatarMoeda(valorPago);
          document.getElementById('valor-pendente').textContent = formatarMoeda(valorPendente);
        }

        function formatarMoeda(valor) {
          return 'R$ ' + valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }
      });
    </script>
  {% endblock %}
  
  {% block ultimos_registros %}{% endblock %}
</main>
