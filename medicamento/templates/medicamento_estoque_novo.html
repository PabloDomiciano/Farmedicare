{% extends 'modelo.html' %}
{% load static %}
{% block titulo %}<title>{{ title }}</title>{% endblock %}

{% block conteudo %}
<main class="main-content">{# Controle de Vencimento de Medicamentos #}
  <header class="content-header">
    <h1>{{ titulo }}</h1>
    <div class="header-actions">
      {% block admin %}{% endblock %}
    </div>
  </header>
  {% block conteudo_admin %}{% endblock %}
{% endblock %}

{% block cards %}{% endblock %}

{% block graficos %}
  <style>
    /* Barra de Pesquisa */
    .search-container {
      margin: 20px auto;
      padding: 0 20px;
      max-width: 1200px;
    }

    .search-form {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-input-wrapper {
      flex: 1;
      position: relative;
      min-width: 200px;
    }

    .search-input {
      width: 100%;
      padding: 10px 40px 10px 15px;
      border: 2px solid #42a5f5;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: #1976d2;
      box-shadow: 0 0 8px rgba(66, 165, 245, 0.3);
    }

    .search-icon {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #42a5f5;
      pointer-events: none;
    }

    .search-btn,
    .clear-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-weight: 600;
    }

    .search-btn {
      background-color: #42a5f5;
      color: white;
    }

    .search-btn:hover {
      background-color: #1976d2;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(66, 165, 245, 0.3);
    }

    .clear-btn {
      background-color: #6c757d;
      color: white;
      text-decoration: none;
    }

    .clear-btn:hover {
      background-color: #5a6268;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
    }

    .search-result-info {
      margin-top: 10px;
      color: #666;
      font-size: 14px;
      padding: 8px 12px;
      background: #e3f2fd;
      border-left: 4px solid #42a5f5;
      border-radius: 4px;
    }

    .search-result-info strong {
      color: #1976d2;
    }

    /* Tema Azul para Medicamentos */
    .medicamentos-filters {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);
      margin: 20px auto;
      max-width: 1200px;
      border: 2px solid #42a5f5;
    }

    .filter-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .filter-btn-med {
      padding: 10px 20px;
      border: 2px solid #42a5f5;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #1976d2;
    }

    .filter-btn-med:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(66, 165, 245, 0.3);
    }

    .filter-btn-med.active {
      background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
      color: white;
      border-color: #1976d2;
    }

    .filter-btn-med.status-vencido {
      border-color: #d32f2f;
    }

    .filter-btn-med.status-vencido.active {
      background: #d32f2f;
      border-color: #d32f2f;
    }

    .filter-btn-med.status-critico {
      border-color: #f57c00;
    }

    .filter-btn-med.status-critico.active {
      background: #f57c00;
      border-color: #f57c00;
    }

    .filter-btn-med.status-atencao {
      border-color: #fbc02d;
    }

    .filter-btn-med.status-atencao.active {
      background: #fbc02d;
      border-color: #fbc02d;
    }

    .filter-btn-med.status-ok {
      border-color: #388e3c;
    }

    .filter-btn-med.status-ok.active {
      background: #388e3c;
      border-color: #388e3c;
    }

    .filter-stats-med {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      padding-top: 15px;
      border-top: 2px solid #42a5f5;
    }

    .stat-card-med {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-left: 4px solid #42a5f5;
    }

    .stat-label-med {
      color: #666;
      font-size: 13px;
      margin-bottom: 5px;
    }

    .stat-value-med {
      font-weight: bold;
      font-size: 20px;
      color: #1976d2;
    }

    /* Status Badges */
    .status-badge-med {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-block;
      letter-spacing: 0.5px;
    }

    .status-vencido {
      background: #ffebee;
      color: #c62828;
      border: 2px solid #ef5350;
    }

    .status-critico {
      background: #fff3e0;
      color: #e65100;
      border: 2px solid #ff9800;
    }

    .status-atencao {
      background: #fffde7;
      color: #f57f17;
      border: 2px solid #fbc02d;
    }

    .status-ok {
      background: #e8f5e9;
      color: #2e7d32;
      border: 2px solid #66bb6a;
    }

    /* Cores das linhas */
    .modelo-table tbody tr.med-vencido {
      background: #ffebee !important;
      border-left: 5px solid #d32f2f;
    }

    .modelo-table tbody tr.med-critico {
      background: #fff3e0 !important;
      border-left: 5px solid #f57c00;
    }

    .modelo-table tbody tr.med-atencao {
      background: #fffde7 !important;
      border-left: 5px solid #fbc02d;
    }

    .modelo-table tbody tr.med-ok {
      background: #f1f8e9 !important;
      border-left: 5px solid #7cb342;
    }

    .modelo-table tbody tr:hover {
      transform: scale(1.01);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: all 0.3s;
    }

    /* √çcones de alerta */
    .icon-vencido {
      color: #d32f2f;
      font-size: 20px;
      animation: pulse 1.5s infinite;
    }

    .icon-critico {
      color: #f57c00;
      font-size: 18px;
      animation: shake 2s infinite;
    }

    .icon-atencao {
      color: #fbc02d;
      font-size: 16px;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .filter-count-med {
      background: white;
      color: #1976d2;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 12px;
      margin-left: 5px;
      font-weight: bold;
    }

    .action-card-med {
      background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(66, 165, 245, 0.3);
      transition: all 0.3s;
      margin-bottom: 20px;
    }

    .action-card-med:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(66, 165, 245, 0.4);
    }
    
    /* Estilo especial para bot√£o de teste */
    .btn-teste:hover {
      box-shadow: 0 6px 20px rgba(255, 152, 0, 0.5) !important;
      animation: pulse 1s infinite;
    }

    .dias-vencimento {
      font-weight: bold;
      font-size: 16px;
    }

    .dias-vencido {
      color: #d32f2f;
    }

    .dias-critico {
      color: #f57c00;
    }

    .dias-atencao {
      color: #fbc02d;
    }

    .dias-ok {
      color: #388e3c;
    }

    /* Cabe√ßalhos clic√°veis com setinhas de ordena√ß√£o */
    .modelo-table thead th {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 30px;
      color: white !important;
    }

    .modelo-table thead th:hover {
      background-color: #00838f !important;
      color: white !important;
    }

    .modelo-table thead th::after {
      content: '\f0dc';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      position: absolute;
      right: 10px;
      opacity: 0.3;
      font-size: 12px;
      color: white;
    }

    .modelo-table thead th.sortable::after {
      opacity: 0.6;
    }

    .modelo-table thead th.asc::after {
      content: '\f0de';
      opacity: 1;
      color: white;
    }

    .modelo-table thead th.desc::after {
      content: '\f0dd';
      opacity: 1;
      color: white;
    }

    /* Estilos para o popup de sa√≠da */
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 9999;
      animation: fadeIn 0.3s;
    }

    .popup-overlay.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .popup-saida {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }

    .popup-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1976d2;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .popup-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #999;
      cursor: pointer;
      transition: all 0.2s;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .popup-close:hover {
      background: #f5f5f5;
      color: #d32f2f;
      transform: rotate(90deg);
    }

    .popup-body {
      margin-bottom: 25px;
    }

    .info-medicamento {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #1976d2;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .info-label {
      color: #666;
      font-weight: 500;
    }

    .info-value {
      color: #1976d2;
      font-weight: 700;
    }

    .quantidade-control {
      margin-top: 20px;
    }

    .quantidade-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      display: block;
    }

    .quantidade-display {
      text-align: center;
      margin-bottom: 15px;
    }

    .quantidade-valor {
      font-size: 48px;
      font-weight: 700;
      color: #1976d2;
      line-height: 1;
    }

    .quantidade-max {
      font-size: 14px;
      color: #999;
      margin-top: 5px;
    }

    .slider-container {
      position: relative;
      margin: 20px 0;
    }

    .quantidade-slider {
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: linear-gradient(to right, #bbdefb 0%, #1976d2 100%);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .quantidade-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #1976d2;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(25, 118, 210, 0.4);
      transition: all 0.2s;
    }

    .quantidade-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 4px 12px rgba(25, 118, 210, 0.6);
    }

    .quantidade-slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #1976d2;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(25, 118, 210, 0.4);
      transition: all 0.2s;
    }

    .quantidade-slider::-moz-range-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 4px 12px rgba(25, 118, 210, 0.6);
    }

    .quantidade-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }

    .btn-quantidade {
      background: #e3f2fd;
      border: 2px solid #1976d2;
      color: #1976d2;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      font-size: 14px;
    }

    .btn-quantidade:hover {
      background: #1976d2;
      color: white;
      transform: translateY(-2px);
    }

    .popup-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn-popup {
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-size: 15px;
    }

    .btn-cancelar {
      background: #f5f5f5;
      color: #666;
    }

    .btn-cancelar:hover {
      background: #e0e0e0;
    }

    .btn-confirmar {
      background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(211, 47, 47, 0.3);
    }

    .btn-confirmar:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4);
    }

    .btn-confirmar:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Bot√µes de a√ß√£o padronizados */
    .btn-action {
      padding: 8px 14px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      border: none;
      cursor: pointer;
      font-size: 12px;
      margin: 0 3px;
      white-space: nowrap;
    }

    .btn-saida {
      background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
      color: white;
      box-shadow: 0 2px 6px rgba(211, 47, 47, 0.3);
    }

    .btn-saida:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(211, 47, 47, 0.4);
      background: linear-gradient(135deg, #c62828 0%, #b71c1c 100%);
    }

    .btn-entrada {
      background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
      color: white;
      box-shadow: 0 2px 6px rgba(25, 118, 210, 0.3);
    }

    .btn-entrada:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(25, 118, 210, 0.4);
      background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);
    }

    .actions {
      white-space: nowrap;
    }

    /* Toast Notification */
    .toast-notification {
      position: fixed;
      top: 80px;
      right: -400px;
      background: white;
      padding: 20px 25px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 15px;
      min-width: 350px;
      max-width: 450px;
      transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      border-left: 5px solid #4caf50;
    }

    .toast-notification.show {
      right: 20px;
    }

    .toast-notification.success {
      border-left-color: #4caf50;
    }

    .toast-notification.error {
      border-left-color: #f44336;
    }

    .toast-icon {
      font-size: 28px;
      flex-shrink: 0;
    }

    .toast-notification.success .toast-icon {
      color: #4caf50;
    }

    .toast-notification.error .toast-icon {
      color: #f44336;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 4px;
      color: #333;
    }

    .toast-message {
      font-size: 14px;
      color: #666;
      line-height: 1.4;
    }

    .toast-close {
      background: none;
      border: none;
      font-size: 20px;
      color: #999;
      cursor: pointer;
      padding: 5px;
      line-height: 1;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .toast-close:hover {
      color: #333;
      transform: rotate(90deg);
    }

    .toast-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: linear-gradient(90deg, #4caf50 0%, #81c784 100%);
      border-radius: 0 0 0 12px;
      animation: toast-progress 3s linear forwards;
    }

    .toast-notification.error .toast-progress {
      background: linear-gradient(90deg, #f44336 0%, #ef5350 100%);
    }

    @keyframes toast-progress {
      from {
        width: 100%;
      }
      to {
        width: 0%;
      }
    }

    /* Responsividade */
    @media (max-width: 768px) {
      .search-form {
        gap: 8px;
      }

      .search-input-wrapper {
        min-width: 150px;
      }

      .search-input {
        font-size: 13px;
        padding: 9px 35px 9px 12px;
      }

      .search-btn,
      .clear-btn {
        padding: 9px 16px;
        font-size: 13px;
      }
    }

    @media (max-width: 576px) {
      .search-form {
        flex-direction: column;
        gap: 10px;
      }

      .search-input-wrapper {
        width: 100%;
        min-width: unset;
      }

      .search-btn,
      .clear-btn {
        width: 100%;
        justify-content: center;
        padding: 10px;
      }

      .search-result-info {
        font-size: 12px;
      }
    }

    @media (max-width: 400px) {
      .search-btn .btn-text,
      .clear-btn .btn-text {
        display: none;
      }

      .search-btn,
      .clear-btn {
        width: auto;
        min-width: 45px;
      }

      .search-form {
        flex-direction: row;
      }

      .search-input-wrapper {
        flex: 1;
      }
    }
  </style>

  <!-- Bot√£o de Nova Entrada -->
  <div style="max-width: 1200px; margin: 20px auto; padding: 0 20px;">
    <a href="{% url 'entrada_medicamento_create' %}" class="action-card-med">
      <i class="fas fa-plus-circle" style="font-size: 24px;"></i>
      <span>{{ btn_cadastrar }}</span>
    </a>
  </div>

  <!-- Barra de Pesquisa -->
  <div class="search-container">
    <form method="get" action="" class="search-form">
      <div class="search-input-wrapper">
        <input 
          type="text" 
          name="search" 
          id="searchInput"
          value="{{ search_query|default:'' }}" 
          placeholder="Pesquisar medicamentos..."
          class="search-input"
        />
        <i class="fas fa-search search-icon"></i>
      </div>
      
      <button type="submit" class="btn btn-primary search-btn">
        <i class="fas fa-search"></i> 
        <span class="btn-text">Pesquisar</span>
      </button>
      
      {% if search_query %}
      <a href="?" class="btn btn-secondary clear-btn">
        <i class="fas fa-times"></i> 
        <span class="btn-text">Limpar</span>
      </a>
      {% endif %}
      
      {% for key, value in request.GET.items %}
        {% if key != 'search' and key != 'page' %}
          <input type="hidden" name="{{ key }}" value="{{ value }}">
        {% endif %}
      {% endfor %}
    </form>
    
    {% if search_query %}
    <div class="search-result-info">
      <i class="fas fa-info-circle"></i> 
      Pesquisando por: <strong>{{ search_query }}</strong>
      {% if page_obj.paginator.count %}
        - {{ page_obj.paginator.count }} resultado(s) encontrado(s)
      {% endif %}
    </div>
    {% endif %}
  </div>

  <!-- Filtros e Estat√≠sticas -->
  <div class="medicamentos-filters">
    <div class="filter-buttons">
      <button class="filter-btn-med active" data-filter="todos">
        <i class="fas fa-list"></i>
        Todos <span class="filter-count-med" id="count-todos">{{ total_medicamentos }}</span>
      </button>
      <button class="filter-btn-med status-vencido" data-filter="vencido">
        <i class="fas fa-times-circle"></i>
        Vencidos <span class="filter-count-med" id="count-vencido">{{ vencidos }}</span>
      </button>
      <button class="filter-btn-med status-critico" data-filter="critico">
        <i class="fas fa-exclamation-triangle"></i>
        Cr√≠tico (‚â§30d) <span class="filter-count-med" id="count-critico">{{ proximo_vencer }}</span>
      </button>
      <button class="filter-btn-med status-atencao" data-filter="atencao">
        <i class="fas fa-exclamation-circle"></i>
        Aten√ß√£o (‚â§60d) <span class="filter-count-med" id="count-atencao">{{ atencao }}</span>
      </button>
      <button class="filter-btn-med status-ok" data-filter="ok">
        <i class="fas fa-check-circle"></i>
        OK (>60d) <span class="filter-count-med" id="count-ok">{{ ok }}</span>
      </button>
    </div>

    <div class="filter-stats-med">
      <div class="stat-card-med">
        <div class="stat-label-med">üíä Total de Medicamentos</div>
        <div class="stat-value-med">{{ total_medicamentos }}</div>
      </div>
      <div class="stat-card-med">
        <div class="stat-label-med">üì¶ Quantidade em Estoque</div>
        <div class="stat-value-med">{{ total_quantidade }}</div>
      </div>
      <div class="stat-card-med" style="border-left-color: #d32f2f;">
        <div class="stat-label-med">üö® Vencidos</div>
        <div class="stat-value-med" style="color: #d32f2f;">{{ vencidos }}</div>
      </div>
      <div class="stat-card-med" style="border-left-color: #f57c00;">
        <div class="stat-label-med">‚ö†Ô∏è Cr√≠ticos (‚â§30 dias)</div>
        <div class="stat-value-med" style="color: #f57c00;">{{ proximo_vencer }}</div>
      </div>
    </div>
  </div>

  <!-- Tabela de Medicamentos -->
  <div class="modelo-lista-container">
    <div class="table-container">
      <table class="modelo-table">
        <thead>
          <tr>
            <th>Status</th>
            <th>Medicamento</th>
            <th>Fazenda</th>
            <th>Quantidade</th>
            <th>Pr√≥xima Validade</th>
            <th>Dias para Vencer</th>
            <th>Lote</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="medicamentos-tbody">
          {% for med in medicamentos_data %}
          <tr class="med-row med-{{ med.status }}"
              data-status="{{ med.status }}"
              data-dias="{{ med.dias_para_vencer }}"
              data-search="{{ med.nome }} {{ med.fazenda.nome }} {{ med.lote }}">
            
            <td style="text-align: center;">
              {% if med.status == 'vencido' %}
                <i class="fas fa-times-circle icon-vencido" title="VENCIDO"></i>
              {% elif med.status == 'critico' %}
                <i class="fas fa-exclamation-triangle icon-critico" title="CR√çTICO"></i>
              {% elif med.status == 'atencao' %}
                <i class="fas fa-exclamation-circle icon-atencao" title="ATEN√á√ÉO"></i>
              {% else %}
                <i class="fas fa-check-circle" style="color: #388e3c; font-size: 18px;" title="OK"></i>
              {% endif %}
            </td>
            
            <td>
              <strong style="font-size: 15px; color: #1976d2;">{{ med.nome }}</strong>
              <div style="font-size: 12px; color: #666; margin-top: 4px;">
                <i class="fas fa-tag"></i> {{ med.lote }}
              </div>
            </td>
            
            <td>
              <i class="fas fa-home" style="color: #1976d2;"></i>
              {{ med.fazenda.nome }}
            </td>
            
            <td style="text-align: center;">
              <strong style="font-size: 16px; color: #1976d2;">{{ med.quantidade_total }}</strong>
              <div style="font-size: 11px; color: #666;">unidades</div>
            </td>
            
            <td>
              <strong style="font-size: 14px;">{{ med.proxima_validade|date:"d/m/Y" }}</strong>
              <div style="font-size: 12px; color: #666; margin-top: 4px;">
                {{ med.proxima_validade|date:"D" }}
              </div>
            </td>
            
            <td style="text-align: center;">
              {% if med.dias_para_vencer < 0 %}
                <div class="dias-vencimento dias-vencido">
                  <i class="fas fa-times-circle"></i> H√° {{ med.dias_vencido_abs }} dias
                </div>
                <span class="status-badge-med status-vencido">VENCIDO</span>
              {% elif med.dias_para_vencer <= 30 %}
                <div class="dias-vencimento dias-critico">
                  <i class="fas fa-exclamation-triangle"></i> {{ med.dias_para_vencer }} dias
                </div>
                <span class="status-badge-med status-critico">CR√çTICO</span>
              {% elif med.dias_para_vencer <= 60 %}
                <div class="dias-vencimento dias-atencao">
                  <i class="fas fa-exclamation-circle"></i> {{ med.dias_para_vencer }} dias
                </div>
                <span class="status-badge-med status-atencao">ATEN√á√ÉO</span>
              {% else %}
                <div class="dias-vencimento dias-ok">
                  <i class="fas fa-check-circle"></i> {{ med.dias_para_vencer }} dias
                </div>
                <span class="status-badge-med status-ok">OK</span>
              {% endif %}
            </td>
            
            <td>
              <div style="font-size: 13px;">{{ med.lote }}</div>
            </td>
            
            <td class="actions">
              <button class="btn-saida btn-action" 
                      onclick="abrirPopupSaida('{{ med.nome }}', '{{ med.fazenda.nome }}', '{{ med.lote }}', {{ med.quantidade_total }}, {{ med.id }})"
                      title="Dar sa√≠da de estoque">
                <i class="fas fa-minus-circle"></i> Sa√≠da
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
              <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
              <div>{{ registros }}</div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <!-- Pagina√ß√£o -->
      {% include "paginacao.html" %}
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast-notification" id="toastNotification">
    <i class="fas fa-check-circle toast-icon"></i>
    <div class="toast-content">
      <div class="toast-title" id="toastTitle">Sucesso!</div>
      <div class="toast-message" id="toastMessage">Opera√ß√£o realizada com sucesso.</div>
    </div>
    <button class="toast-close" onclick="fecharToast()">
      <i class="fas fa-times"></i>
    </button>
    <div class="toast-progress"></div>
  </div>

  <!-- Popup de Sa√≠da de Medicamento -->
  <div class="popup-overlay" id="popupSaida">
    <div class="popup-saida">
      <div class="popup-header">
        <h3 class="popup-title">
          <i class="fas fa-minus-circle"></i>
          Dar Sa√≠da de Medicamento
        </h3>
        <button class="popup-close" onclick="fecharPopupSaida()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="popup-body">
        <div class="info-medicamento">
          <div class="info-item">
            <span class="info-label">üíä Medicamento:</span>
            <span class="info-value" id="popup-nome"></span>
          </div>
          <div class="info-item">
            <span class="info-label">üè† Fazenda:</span>
            <span class="info-value" id="popup-fazenda"></span>
          </div>
          <div class="info-item">
            <span class="info-label">üì¶ Lote:</span>
            <span class="info-value" id="popup-lote"></span>
          </div>
          <div class="info-item">
            <span class="info-label">üìä Estoque Atual:</span>
            <span class="info-value" id="popup-estoque"></span>
          </div>
        </div>

        <div class="quantidade-control">
          <label class="quantidade-label">Quantidade para dar sa√≠da:</label>
          
          <div class="quantidade-display">
            <div class="quantidade-valor" id="quantidade-valor">0</div>
            <div class="quantidade-max">de <span id="quantidade-max">0</span> unidades</div>
          </div>

          <div class="slider-container">
            <input type="range" 
                   class="quantidade-slider" 
                   id="quantidade-slider"
                   min="0" 
                   max="100" 
                   value="0"
                   oninput="atualizarQuantidade(this.value)">
          </div>

          <div class="quantidade-buttons">
            <button class="btn-quantidade" onclick="ajustarQuantidade(-10)">
              <i class="fas fa-minus"></i> 10
            </button>
            <button class="btn-quantidade" onclick="ajustarQuantidade(-1)">
              <i class="fas fa-minus"></i> 1
            </button>
            <button class="btn-quantidade" onclick="ajustarQuantidade(1)">
              <i class="fas fa-plus"></i> 1
            </button>
            <button class="btn-quantidade" onclick="ajustarQuantidade(10)">
              <i class="fas fa-plus"></i> 10
            </button>
            <button class="btn-quantidade" onclick="setarMaximo()">
              M√°ximo
            </button>
          </div>
        </div>
      </div>

      <div class="popup-footer">
        <button class="btn-popup btn-cancelar" onclick="fecharPopupSaida()">
          Cancelar
        </button>
        <button class="btn-popup btn-confirmar" id="btn-confirmar" onclick="confirmarSaida()" disabled>
          <i class="fas fa-check"></i> Confirmar Sa√≠da
        </button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const filterButtons = document.querySelectorAll('.filter-btn-med');
      const medRows = document.querySelectorAll('.med-row');
      let currentFilter = 'todos';

      filterButtons.forEach(button => {
        button.addEventListener('click', function() {
          filterButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          currentFilter = this.dataset.filter;
          aplicarFiltros();
        });
      });

      // Fun√ß√£o de filtro agora s√≥ filtra por status (a pesquisa √© feita no backend)
      function aplicarFiltros() {
        medRows.forEach(row => {
          const status = row.dataset.status;
          const statusMatch = currentFilter === 'todos' || status === currentFilter;
          row.style.display = statusMatch ? '' : 'none';
        });
      }
    });

    // Vari√°veis globais para o popup
    let quantidadeMaxima = 0;
    let quantidadeAtual = 0;
    let medicamentoId = null;
    let toastTimeout = null;

    // Fun√ß√µes do Toast
    function mostrarToast(titulo, mensagem, tipo = 'success') {
      const toast = document.getElementById('toastNotification');
      const toastTitle = document.getElementById('toastTitle');
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = toast.querySelector('.toast-icon');
      
      // Limpar classe anterior
      toast.classList.remove('success', 'error');
      
      // Configurar conte√∫do
      toastTitle.textContent = titulo;
      toastMessage.textContent = mensagem;
      
      // Configurar tipo e √≠cone
      toast.classList.add(tipo);
      if (tipo === 'success') {
        toastIcon.className = 'fas fa-check-circle toast-icon';
      } else if (tipo === 'error') {
        toastIcon.className = 'fas fa-exclamation-circle toast-icon';
      }
      
      // Remover anima√ß√£o de progresso anterior se existir
      const oldProgress = toast.querySelector('.toast-progress');
      if (oldProgress) {
        oldProgress.remove();
      }
      
      // Adicionar nova barra de progresso
      const progress = document.createElement('div');
      progress.className = 'toast-progress';
      toast.appendChild(progress);
      
      // Mostrar toast
      toast.classList.add('show');
      
      // Limpar timeout anterior
      if (toastTimeout) {
        clearTimeout(toastTimeout);
      }
      
      // Esconder automaticamente ap√≥s 3 segundos (mesmo tempo da barra de progresso)
      toastTimeout = setTimeout(() => {
        fecharToast();
      }, 3000);
    }

    function fecharToast() {
      const toast = document.getElementById('toastNotification');
      toast.classList.remove('show');
      if (toastTimeout) {
        clearTimeout(toastTimeout);
      }
    }

    function abrirPopupSaida(nome, fazenda, lote, estoque, id) {
      document.getElementById('popup-nome').textContent = nome;
      document.getElementById('popup-fazenda').textContent = fazenda;
      document.getElementById('popup-lote').textContent = lote;
      document.getElementById('popup-estoque').textContent = estoque + ' unidades';
      
      quantidadeMaxima = estoque;
      medicamentoId = id;
      document.getElementById('quantidade-max').textContent = estoque;
      document.getElementById('quantidade-slider').max = estoque;
      document.getElementById('quantidade-slider').value = 0;
      document.getElementById('quantidade-valor').textContent = 0;
      quantidadeAtual = 0;
      
      document.getElementById('btn-confirmar').disabled = true;
      document.getElementById('popupSaida').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function fecharPopupSaida() {
      document.getElementById('popupSaida').classList.remove('active');
      document.body.style.overflow = '';
    }

    function atualizarQuantidade(valor) {
      quantidadeAtual = parseInt(valor);
      document.getElementById('quantidade-valor').textContent = quantidadeAtual;
      document.getElementById('btn-confirmar').disabled = quantidadeAtual === 0;
    }

    function ajustarQuantidade(delta) {
      let novoValor = quantidadeAtual + delta;
      if (novoValor < 0) novoValor = 0;
      if (novoValor > quantidadeMaxima) novoValor = quantidadeMaxima;
      
      document.getElementById('quantidade-slider').value = novoValor;
      atualizarQuantidade(novoValor);
    }

    function setarMaximo() {
      document.getElementById('quantidade-slider').value = quantidadeMaxima;
      atualizarQuantidade(quantidadeMaxima);
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function confirmarSaida() {
      if (quantidadeAtual === 0) {
        mostrarToast('Aten√ß√£o!', 'Selecione uma quantidade v√°lida para dar sa√≠da.', 'error');
        return;
      }

      const btnConfirmar = document.getElementById('btn-confirmar');
      
      // Desabilitar bot√£o durante o processamento
      btnConfirmar.disabled = true;
      btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
      
      const dados = {
        medicamento_id: medicamentoId,
        quantidade: quantidadeAtual,
        motivo: ''
      };

      console.log('Enviando dados:', dados);
      console.log('URL:', '{% url "saida_medicamento_api" %}');

      // Chamada AJAX para registrar a sa√≠da
      fetch('{% url "saida_medicamento_api" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(dados)
      })
      .then(response => {
        console.log('Response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.success) {
          fecharPopupSaida();
          mostrarToast('Sa√≠da Registrada!', data.message, 'success');
          
          // Recarregar p√°gina ap√≥s a notifica√ß√£o sumir (3.5 segundos)
          setTimeout(() => {
            location.reload();
          }, 3500);
        } else {
          mostrarToast('Erro!', data.error, 'error');
          btnConfirmar.disabled = false;
          btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Confirmar Sa√≠da';
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        mostrarToast('Erro!', 'Erro ao processar sa√≠da. Tente novamente.', 'error');
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Confirmar Sa√≠da';
      });
    }

    // Fechar popup ao clicar fora
    document.getElementById('popupSaida').addEventListener('click', function(e) {
      if (e.target === this) {
        fecharPopupSaida();
      }
    });
  </script>
{% endblock %}

{% block ultimos_registros %}{% endblock %}
</main>
